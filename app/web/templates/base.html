<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}政策情报助手{% endblock %}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <style>
    [hx-indicator] .htmx-indicator { display: none; }
    .htmx-request .htmx-indicator { display: inline-block; }
    .sidebar-link { display: flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: 8px; color: #374151; text-decoration: none; transition: all 0.15s; }
    .sidebar-link:hover { background: #f3f4f6; }
    .sidebar-link.active { background: #eff6ff; color: #1d4ed8; font-weight: 600; }
    .card { background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.15s; border: none; }
    .btn-primary { background: #1d4ed8; color: white; }
    .btn-primary:hover { background: #1e40af; }
    .btn-secondary { background: #f3f4f6; color: #374151; }
    .btn-secondary:hover { background: #e5e7eb; }
    .btn-danger { background: #fef2f2; color: #dc2626; }
    .btn-danger:hover { background: #fee2e2; }
    .badge { display: inline-block; padding: 2px 10px; border-radius: 999px; font-size: 12px; font-weight: 500; }
    .badge-green { background: #dcfce7; color: #166534; }
    .badge-yellow { background: #fef9c3; color: #854d0e; }
    .badge-red { background: #fef2f2; color: #dc2626; }
    .badge-blue { background: #dbeafe; color: #1e40af; }
    .badge-gray { background: #f3f4f6; color: #6b7280; }
    .badge-orange { background: #fff7ed; color: #c2410c; }
    .btn-sm { padding: 4px 10px; font-size: 12px; }
    .form-input { width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; outline: none; transition: border 0.15s; }
    .form-input:focus { border-color: #1d4ed8; box-shadow: 0 0 0 3px rgba(29,78,216,0.1); }
    .form-label { display: block; margin-bottom: 4px; font-size: 14px; font-weight: 500; color: #374151; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; color: white; font-size: 14px; z-index: 1000; animation: fadeInOut 3s ease; }
    @keyframes fadeInOut { 0% { opacity:0; transform:translateY(-10px); } 10% { opacity:1; transform:translateY(0); } 80% { opacity:1; } 100% { opacity:0; } }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-56 bg-white border-r border-gray-200 flex flex-col py-6 px-4 fixed h-full">
      <div class="mb-8 px-2">
        <h1 class="text-lg font-bold text-gray-900">政策情报助手</h1>
        <p class="text-xs text-gray-400 mt-1">Policy Intelligence</p>
      </div>
      <nav class="flex-1 space-y-1">
        <a href="/" class="sidebar-link {% if active_page == 'dashboard' %}active{% endif %}">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1"/></svg>
          总览
        </a>
        <a href="/sources" class="sidebar-link {% if active_page == 'sources' %}active{% endif %}">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"/></svg>
          监控源
        </a>
        <a href="/reports" class="sidebar-link {% if active_page == 'reports' %}active{% endif %}">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          报告
        </a>
        <a href="/tasks" class="sidebar-link {% if active_page == 'tasks' %}active{% endif %}">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
          任务
        </a>
        <a href="/push-rules" class="sidebar-link {% if active_page == 'push_rules' %}active{% endif %}">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
          推送规则
        </a>
        {% if user and user.role == 'admin' %}
        <a href="/accounts" class="sidebar-link {% if active_page == 'accounts' %}active{% endif %}">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
          账号管理
        </a>
        <a href="/settings" class="sidebar-link {% if active_page == 'settings' %}active{% endif %}">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          设置
        </a>
        {% endif %}
      </nav>

      <!-- User info + data switcher at bottom -->
      <div class="border-t border-gray-200 pt-4 mt-4 space-y-3">
        {% if user and user.role == 'admin' %}
        <div>
          <label class="text-xs text-gray-400 block mb-1">查看数据</label>
          <select id="viewUserSelect" class="form-input text-xs py-1" onchange="onViewUserChange()" style="font-size:12px">
            <option value="">我的数据</option>
            <option value="0">全部用户</option>
          </select>
        </div>
        {% endif %}
        <div class="flex items-center justify-between">
          <div class="min-w-0">
            <p class="text-sm font-medium text-gray-900 truncate">{{ user.display_name or user.username }}</p>
            <p class="text-xs text-gray-400">{{ '管理员' if user.role == 'admin' else '普通用户' }}</p>
          </div>
          <button onclick="doLogout()" class="text-xs text-gray-400 hover:text-red-500 transition-colors" title="退出登录">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main content -->
    <main class="flex-1 ml-56 p-8">
      {% block content %}{% endblock %}
    </main>
  </div>

  <script>
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Global HTMX after-request handler
    document.addEventListener('htmx:afterRequest', function(e) {
      if (e.detail.successful) {
        const trigger = e.detail.elt.getAttribute('data-success-msg');
        if (trigger) showToast(trigger);
      }
    });

    // --- Logout ---
    async function doLogout() {
      await fetch('/api/auth/logout', { method: 'POST' });
      window.location.href = '/login';
    }

    // --- Admin data switcher ---
    function getViewUserParam() {
      const v = localStorage.getItem('view_user_id');
      return (v !== null && v !== '') ? v : null;
    }

    function appendViewUserParam(params) {
      const v = getViewUserParam();
      if (v !== null) params.set('view_user_id', v);
      return params;
    }

    function onViewUserChange() {
      const sel = document.getElementById('viewUserSelect');
      if (!sel) return;
      const val = sel.value;
      if (val === '') {
        localStorage.removeItem('view_user_id');
      } else {
        localStorage.setItem('view_user_id', val);
      }
      // Reload current page
      window.location.reload();
    }

    // On page load: restore view_user_id select + load user list for admin
    (async function initViewUser() {
      const sel = document.getElementById('viewUserSelect');
      if (!sel) return;

      // Load user list for admin dropdown
      try {
        const res = await fetch('/api/users');
        if (res.ok) {
          const users = await res.json();
          users.forEach(u => {
            if (u.id === {{ user.id if user else 0 }}) return; // skip self (already "我的数据")
            const opt = document.createElement('option');
            opt.value = u.id;
            opt.textContent = u.display_name || u.username;
            sel.appendChild(opt);
          });
        }
      } catch(e) { /* ignore */ }

      // Restore selection
      const saved = localStorage.getItem('view_user_id');
      if (saved !== null) sel.value = saved;
    })();
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>
