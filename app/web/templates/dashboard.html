{% extends "base.html" %}
{% block title %}æ€»è§ˆ - æ”¿ç­–æƒ…æŠ¥åŠ©æ‰‹{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <h2 class="text-2xl font-bold text-gray-900">æ€»è§ˆ</h2>
</div>

<!-- Stats -->
<div class="grid grid-cols-4 gap-4 mb-6">
  <div class="card">
    <p class="text-sm text-gray-500">ç›‘æ§æº</p>
    <p class="text-3xl font-bold text-gray-900 mt-1">{{ stats.total_sources }}</p>
    <p class="text-xs text-gray-400 mt-1">{{ stats.active_sources }} ä¸ªæ´»è·ƒ</p>
  </div>
  <div class="card">
    <p class="text-sm text-gray-500">æ€»é‡‡é›†å†…å®¹</p>
    <p class="text-3xl font-bold text-gray-900 mt-1">{{ stats.total_results }}</p>
  </div>
  <div class="card">
    <p class="text-sm text-gray-500">æŠ¥å‘Šæ•°é‡</p>
    <p class="text-3xl font-bold text-gray-900 mt-1">{{ stats.total_reports }}</p>
  </div>
  <div class="card">
    <p class="text-sm text-gray-500">ä¸Šæ¬¡é‡‡é›†</p>
    <p class="text-lg font-semibold text-gray-900 mt-1">{{ stats.last_crawl or 'æš‚æ— ' }}</p>
  </div>
</div>

<!-- Sources Status -->
<div class="card mb-6">
  <h3 class="text-lg font-semibold text-gray-900 mb-4">ç›‘æ§æºçŠ¶æ€</h3>
  {% if sources %}
  <div class="space-y-3" id="sourcesList">
    {% for s in sources %}
    <div class="source-item flex items-center justify-between py-2 border-b border-gray-100 last:border-0" {% if loop.index > 3 %}style="display:none"{% endif %}>
      <div class="flex items-center gap-3">
        {% if s.is_active %}
        <span class="badge badge-green">æ­£å¸¸</span>
        {% else %}
        <span class="badge badge-gray">å·²åœç”¨</span>
        {% endif %}
        <div>
          <p class="font-medium text-gray-900">{{ s.name }}</p>
          <p class="text-xs text-gray-400">{{ s.url }}</p>
        </div>
      </div>
      <div class="text-right text-sm text-gray-500">
        <p>{{ s.last_crawl or 'å°šæœªé‡‡é›†' }}</p>
        {% if s.last_items is not none %}
        <p class="text-xs">ä¸Šæ¬¡å‘ç° {{ s.last_items }} æ¡</p>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% if sources|length > 3 %}
  <button onclick="toggleSources()" id="toggleSourcesBtn" class="btn btn-secondary mt-3 w-full text-center text-sm">
    å±•å¼€æŸ¥çœ‹å…¨éƒ¨ {{ sources|length }} ä¸ªç›‘æ§æº â–¼
  </button>
  {% endif %}
  {% else %}
  <p class="text-gray-400">æš‚æ— ç›‘æ§æº</p>
  {% endif %}
</div>

<!-- Results with dynamic filtering -->
<div class="card">
  <h3 class="text-lg font-semibold text-gray-900 mb-4">æœ€æ–°å†…å®¹æ‘˜è¦</h3>

  <!-- Filter toolbar -->
  <div class="flex flex-wrap items-center gap-3 mb-4">
    <select id="filterSource" class="form-input" style="width:auto;min-width:140px" onchange="fetchResults()">
      <option value="">å…¨éƒ¨ç›‘æ§æº</option>
      {% for s in sources %}
      <option value="{{ s.id }}">{{ s.name }}</option>
      {% endfor %}
    </select>
    <input type="date" id="filterDateFrom" class="form-input" style="width:auto" onchange="fetchResults()">
    <span class="text-gray-400">è‡³</span>
    <input type="date" id="filterDateTo" class="form-input" style="width:auto" onchange="fetchResults()">
    <select id="filterSort" class="form-input" style="width:auto" onchange="fetchResults()">
      <option value="desc">æœ€æ–°ä¼˜å…ˆ</option>
      <option value="asc">æœ€æ—©ä¼˜å…ˆ</option>
    </select>
  </div>

  <!-- Action bar -->
  <div class="flex items-center gap-3 mb-4 text-sm">
    <label class="flex items-center gap-1 cursor-pointer">
      <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
      <span>å…¨é€‰</span>
    </label>
    <span id="selectedCount" class="text-gray-500">å·²é€‰ 0 æ¡</span>
    <button class="btn btn-danger text-xs" id="batchDeleteBtn" onclick="batchDeleteResults()" style="display:none">æ‰¹é‡åˆ é™¤</button>
    <button class="btn btn-danger text-xs" onclick="clearAllResults()">ä¸€é”®æ¸…ç©º</button>
  </div>

  <!-- Results list -->
  <div id="resultsList" class="space-y-4">
    <p class="text-gray-400">åŠ è½½ä¸­...</p>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// --- Source collapse ---
let sourcesExpanded = false;
function toggleSources() {
  sourcesExpanded = !sourcesExpanded;
  const items = document.querySelectorAll('.source-item');
  items.forEach((el, i) => {
    if (i >= 3) el.style.display = sourcesExpanded ? '' : 'none';
  });
  const btn = document.getElementById('toggleSourcesBtn');
  if (btn) {
    btn.textContent = sourcesExpanded
      ? 'æ”¶èµ·ç›‘æ§æº â–²'
      : 'å±•å¼€æŸ¥çœ‹å…¨éƒ¨ {{ sources|length }} ä¸ªç›‘æ§æº â–¼';
  }
}

// --- Results dynamic list ---
let resultsData = [];
let selectedIds = new Set();

async function fetchResults() {
  const params = new URLSearchParams();
  const src = document.getElementById('filterSource').value;
  const df = document.getElementById('filterDateFrom').value;
  const dt = document.getElementById('filterDateTo').value;
  const sort = document.getElementById('filterSort').value;
  if (src) params.set('source_id', src);
  if (df) params.set('date_from', df);
  if (dt) params.set('date_to', dt);
  params.set('sort', sort);
  params.set('limit', '100');

  try {
    const res = await fetch('/api/results?' + params.toString());
    resultsData = await res.json();
    selectedIds.clear();
    renderResults();
  } catch (e) {
    document.getElementById('resultsList').innerHTML = '<p class="text-red-500">åŠ è½½å¤±è´¥</p>';
  }
}

function renderResults() {
  const container = document.getElementById('resultsList');
  if (!resultsData.length) {
    container.innerHTML = '<p class="text-gray-400">æš‚æ— é‡‡é›†å†…å®¹</p>';
    updateSelectedCount();
    return;
  }

  const typeMap = {news:'æ–°é—»', policy:'æ”¿ç­–', notice:'é€šçŸ¥', file:'æ–‡ä»¶'};
  const badgeMap = {news:'badge-gray', policy:'badge-blue', notice:'badge-yellow', file:'badge-gray'};

  container.innerHTML = resultsData.map(r => `
    <div class="border-b border-gray-100 pb-4 last:border-0" data-id="${r.id}">
      <div class="flex items-start gap-2">
        <input type="checkbox" class="result-cb mt-1" value="${r.id}" onchange="onCheckChange()" ${selectedIds.has(r.id) ? 'checked' : ''}>
        <span class="badge ${badgeMap[r.content_type] || 'badge-gray'}">
          ${typeMap[r.content_type] || 'å†…å®¹'}
        </span>
        <div class="flex-1 min-w-0">
          <p class="font-medium text-gray-900">${escHtml(r.title)}</p>
          ${(r.summary && r.summary.trim() !== r.title.trim()) ? `<p class="text-sm text-gray-600 mt-1">${escHtml(r.summary.substring(0, 200))}${r.summary.length > 200 ? '...' : ''}</p>` : ''}
          <div class="flex items-center gap-3 mt-2 text-xs flex-wrap">
            ${r.source_name ? `<span class="text-gray-400">${escHtml(r.source_name)}</span>` : ''}
            ${r.crawled_at ? `<span class="text-gray-400">${r.crawled_at}</span>` : ''}
            <a href="${escHtml(r.url)}" target="_blank" class="text-blue-600 hover:underline">æŸ¥çœ‹åŸæ–‡</a>
            ${r.has_attachment ? `<span class="text-gray-400">ğŸ“ ${escHtml(r.attachment_name)}</span>` : ''}
            <button class="text-red-500 hover:text-red-700" onclick="deleteSingleResult(${r.id})">ğŸ—‘ï¸</button>
          </div>
        </div>
      </div>
    </div>
  `).join('');

  updateSelectedCount();
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

function onCheckChange() {
  selectedIds.clear();
  document.querySelectorAll('.result-cb:checked').forEach(cb => selectedIds.add(Number(cb.value)));
  updateSelectedCount();
}

function toggleSelectAll() {
  const checked = document.getElementById('selectAll').checked;
  document.querySelectorAll('.result-cb').forEach(cb => { cb.checked = checked; });
  selectedIds.clear();
  if (checked) resultsData.forEach(r => selectedIds.add(r.id));
  updateSelectedCount();
}

function updateSelectedCount() {
  document.getElementById('selectedCount').textContent = `å·²é€‰ ${selectedIds.size} æ¡`;
  document.getElementById('batchDeleteBtn').style.display = selectedIds.size > 0 ? '' : 'none';
  const allCb = document.getElementById('selectAll');
  allCb.checked = resultsData.length > 0 && selectedIds.size === resultsData.length;
}

async function deleteSingleResult(id) {
  if (!confirm('ç¡®å®šåˆ é™¤æ­¤æ¡è®°å½•ï¼Ÿ')) return;
  try {
    const res = await fetch(`/api/results/${id}`, { method: 'DELETE' });
    if (res.ok) {
      showToast('å·²åˆ é™¤');
      fetchResults();
    } else {
      const err = await res.text();
      console.error('åˆ é™¤å¤±è´¥:', res.status, err);
      showToast(`åˆ é™¤å¤±è´¥ (${res.status})`, 'error');
    }
  } catch (e) {
    console.error('è¯·æ±‚å¤±è´¥:', e);
    showToast('è¯·æ±‚å¤±è´¥', 'error');
  }
}

async function batchDeleteResults() {
  const ids = Array.from(selectedIds);
  if (!ids.length) return;
  if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${ids.length} æ¡è®°å½•ï¼Ÿ`)) return;
  try {
    const res = await fetch('/api/results/batch-delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ids }),
    });
    if (res.ok) {
      showToast(`å·²åˆ é™¤ ${ids.length} æ¡`);
      fetchResults();
    } else {
      const err = await res.text();
      console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', res.status, err);
      showToast(`åˆ é™¤å¤±è´¥ (${res.status})`, 'error');
    }
  } catch (e) {
    console.error('è¯·æ±‚å¤±è´¥:', e);
    showToast('è¯·æ±‚å¤±è´¥', 'error');
  }
}

async function clearAllResults() {
  if (!confirm('ç¡®å®šæ¸…ç©ºå…¨éƒ¨é‡‡é›†å†…å®¹ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
  try {
    const res = await fetch('/api/results/all', { method: 'DELETE' });
    if (res.ok) {
      showToast('å·²æ¸…ç©º');
      fetchResults();
    } else {
      const err = await res.text();
      console.error('æ¸…ç©ºå¤±è´¥:', res.status, err);
      showToast(`æ¸…ç©ºå¤±è´¥ (${res.status})`, 'error');
    }
  } catch (e) {
    console.error('è¯·æ±‚å¤±è´¥:', e);
    showToast('è¯·æ±‚å¤±è´¥', 'error');
  }
}

// Load on page init
document.addEventListener('DOMContentLoaded', fetchResults);
</script>
{% endblock %}
