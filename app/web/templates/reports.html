{% extends "base.html" %}
{% block title %}æŠ¥å‘Šä¸­å¿ƒ - æ”¿ç­–æƒ…æŠ¥åŠ©æ‰‹{% endblock %}

{% block content %}
<h2 class="text-2xl font-bold text-gray-900 mb-6">æŠ¥å‘Šä¸­å¿ƒ</h2>

<!-- Filter toolbar -->
<div class="flex flex-wrap items-center gap-3 mb-4">
  <input type="date" id="filterDateFrom" class="form-input" style="width:auto" onchange="fetchReports()">
  <span class="text-gray-400">è‡³</span>
  <input type="date" id="filterDateTo" class="form-input" style="width:auto" onchange="fetchReports()">
  <select id="filterSort" class="form-input" style="width:auto" onchange="fetchReports()">
    <option value="desc">æœ€æ–°ä¼˜å…ˆ</option>
    <option value="asc">æœ€æ—©ä¼˜å…ˆ</option>
  </select>
</div>

<!-- Action bar -->
<div class="flex items-center gap-3 mb-4 text-sm">
  <label class="flex items-center gap-1 cursor-pointer">
    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
    <span>å…¨é€‰</span>
  </label>
  <span id="selectedCount" class="text-gray-500">å·²é€‰ 0 æ¡</span>
  <button class="btn btn-danger text-xs" id="batchDeleteBtn" onclick="batchDeleteReports()" style="display:none">æ‰¹é‡åˆ é™¤</button>
  <button class="btn btn-danger text-xs" onclick="clearAllReports()">ä¸€é”®æ¸…ç©º</button>
</div>

<!-- Reports list -->
<div id="reportsList" class="space-y-3">
  <p class="text-gray-400">åŠ è½½ä¸­...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
let reportsData = [];
let selectedIds = new Set();

async function fetchReports() {
  const params = new URLSearchParams();
  const df = document.getElementById('filterDateFrom').value;
  const dt = document.getElementById('filterDateTo').value;
  const sort = document.getElementById('filterSort').value;
  if (df) params.set('date_from', df);
  if (dt) params.set('date_to', dt);
  params.set('sort', sort);

  try {
    const res = await fetch('/api/reports?' + params.toString());
    reportsData = await res.json();
    selectedIds.clear();
    renderReports();
  } catch (e) {
    document.getElementById('reportsList').innerHTML = '<p class="text-red-500">åŠ è½½å¤±è´¥</p>';
  }
}

function renderReports() {
  const container = document.getElementById('reportsList');
  if (!reportsData.length) {
    container.innerHTML = '<div class="card text-center py-12"><p class="text-gray-400">æš‚æ— æŠ¥å‘Š</p></div>';
    updateSelectedCount();
    return;
  }

  container.innerHTML = reportsData.map(r => `
    <div class="card flex items-center gap-3 hover:border-blue-300 transition-colors" data-id="${r.id}">
      <input type="checkbox" class="report-cb" value="${r.id}" onchange="onCheckChange()" ${selectedIds.has(r.id) ? 'checked' : ''}>
      <a href="/reports/${r.id}" class="flex-1 min-w-0">
        <h3 class="font-semibold text-gray-900">${escHtml(r.title)}</h3>
        <div class="flex flex-wrap items-center gap-2 mt-1">
          ${(r.source_names || []).map(n => `<span class="badge badge-blue">${escHtml(n)}</span>`).join('')}
          ${r.total_items ? `<span class="text-xs text-gray-500">${r.total_items} æ¡å†…å®¹</span>` : ''}
          <span class="text-xs text-gray-400">ç”Ÿæˆäº ${r.generated_at || 'æœªçŸ¥'}</span>
        </div>
      </a>
      <button class="text-red-500 hover:text-red-700 text-sm" onclick="deleteSingleReport(${r.id})">ğŸ—‘ï¸</button>
      <a href="/reports/${r.id}">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
      </a>
    </div>
  `).join('');

  updateSelectedCount();
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

function onCheckChange() {
  selectedIds.clear();
  document.querySelectorAll('.report-cb:checked').forEach(cb => selectedIds.add(Number(cb.value)));
  updateSelectedCount();
}

function toggleSelectAll() {
  const checked = document.getElementById('selectAll').checked;
  document.querySelectorAll('.report-cb').forEach(cb => { cb.checked = checked; });
  selectedIds.clear();
  if (checked) reportsData.forEach(r => selectedIds.add(r.id));
  updateSelectedCount();
}

function updateSelectedCount() {
  document.getElementById('selectedCount').textContent = `å·²é€‰ ${selectedIds.size} æ¡`;
  document.getElementById('batchDeleteBtn').style.display = selectedIds.size > 0 ? '' : 'none';
  const allCb = document.getElementById('selectAll');
  allCb.checked = reportsData.length > 0 && selectedIds.size === reportsData.length;
}

async function deleteSingleReport(id) {
  if (!confirm('ç¡®å®šåˆ é™¤æ­¤æŠ¥å‘Šï¼Ÿ')) return;
  try {
    const res = await fetch(`/api/reports/${id}`, { method: 'DELETE' });
    if (res.ok) {
      showToast('å·²åˆ é™¤');
      fetchReports();
    } else {
      const err = await res.text();
      console.error('åˆ é™¤å¤±è´¥:', res.status, err);
      showToast(`åˆ é™¤å¤±è´¥ (${res.status})`, 'error');
    }
  } catch (e) {
    console.error('è¯·æ±‚å¤±è´¥:', e);
    showToast('è¯·æ±‚å¤±è´¥', 'error');
  }
}

async function batchDeleteReports() {
  const ids = Array.from(selectedIds);
  if (!ids.length) return;
  if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${ids.length} ä¸ªæŠ¥å‘Šï¼Ÿ`)) return;
  try {
    const res = await fetch('/api/reports/batch-delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ids }),
    });
    if (res.ok) {
      showToast(`å·²åˆ é™¤ ${ids.length} ä¸ªæŠ¥å‘Š`);
      fetchReports();
    } else {
      const err = await res.text();
      console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', res.status, err);
      showToast(`åˆ é™¤å¤±è´¥ (${res.status})`, 'error');
    }
  } catch (e) {
    console.error('è¯·æ±‚å¤±è´¥:', e);
    showToast('è¯·æ±‚å¤±è´¥', 'error');
  }
}

async function clearAllReports() {
  if (!confirm('ç¡®å®šæ¸…ç©ºå…¨éƒ¨æŠ¥å‘Šï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
  try {
    const res = await fetch('/api/reports/all', { method: 'DELETE' });
    if (res.ok) {
      showToast('å·²æ¸…ç©º');
      fetchReports();
    } else {
      const err = await res.text();
      console.error('æ¸…ç©ºå¤±è´¥:', res.status, err);
      showToast(`æ¸…ç©ºå¤±è´¥ (${res.status})`, 'error');
    }
  } catch (e) {
    console.error('è¯·æ±‚å¤±è´¥:', e);
    showToast('è¯·æ±‚å¤±è´¥', 'error');
  }
}

// Load on page init
document.addEventListener('DOMContentLoaded', fetchReports);
</script>
{% endblock %}
