{% extends "base.html" %}
{% block title %}任务管理 - 政策情报助手{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <h2 class="text-2xl font-bold text-gray-900">任务管理</h2>
  <div class="flex items-center gap-3">
    <span id="runningIndicator" class="text-sm text-gray-400"></span>
    <button class="btn btn-danger text-sm" onclick="clearFinished()">清空已完成</button>
    <button class="btn btn-secondary" onclick="location.reload()">刷新</button>
  </div>
</div>

{% if tasks %}
<div class="card overflow-hidden">
  <table class="w-full text-sm">
    <thead class="bg-gray-50">
      <tr>
        <th class="text-left px-4 py-3 font-medium text-gray-500">监控源</th>
        <th class="text-left px-4 py-3 font-medium text-gray-500">批次</th>
        <th class="text-left px-4 py-3 font-medium text-gray-500">状态</th>
        <th class="text-left px-4 py-3 font-medium text-gray-500">触发方式</th>
        <th class="text-left px-4 py-3 font-medium text-gray-500">发现条数</th>
        <th class="text-left px-4 py-3 font-medium text-gray-500">开始时间</th>
        <th class="text-left px-4 py-3 font-medium text-gray-500">完成时间</th>
        <th class="text-left px-4 py-3 font-medium text-gray-500">操作</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-100">
      {% for t in tasks %}
      <tr class="hover:bg-gray-50 {% if t.status == 'running' or t.progress_log %}cursor-pointer{% endif %}"
          {% if t.status == 'running' or t.progress_log %}onclick="toggleProgress({{ t.id }})"{% endif %}>
        <td class="px-4 py-3 font-medium text-gray-900">{{ t.source_name }}</td>
        <td class="px-4 py-3 text-gray-500 font-mono text-xs">{{ t.batch_id[:8] }}</td>
        <td class="px-4 py-3">
          {% if t.status == 'completed' %}
          <span class="badge badge-green">已完成</span>
          {% elif t.status == 'running' %}
          <span class="badge badge-blue">运行中</span>
          {% elif t.status == 'failed' %}
          <span class="badge badge-red" title="{{ t.error_log }}">失败</span>
          {% elif t.status == 'cancelled' %}
          <span class="badge badge-orange">已中止</span>
          {% else %}
          <span class="badge badge-gray">待执行</span>
          {% endif %}
        </td>
        <td class="px-4 py-3 text-gray-500">{{ '手动' if t.triggered_by == 'manual' else '定时' }}</td>
        <td class="px-4 py-3 text-gray-900">{{ t.items_found }}</td>
        <td class="px-4 py-3 text-gray-500 text-xs">{{ t.started_at or '-' }}</td>
        <td class="px-4 py-3 text-gray-500 text-xs">{{ t.completed_at or '-' }}</td>
        <td class="px-4 py-3">
          {% if t.status == 'running' %}
          <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); cancelTask({{ t.id }})">中止</button>
          {% endif %}
        </td>
      </tr>
      {% if t.status == 'running' or t.progress_log %}
      <tr id="progress-row-{{ t.id }}" class="{% if t.status != 'running' %}hidden{% endif %}">
        <td colspan="8" class="px-4 py-3 bg-gray-50">
          <div class="text-xs text-gray-500 mb-1 font-medium">采集进度:</div>
          <pre id="progress-log-{{ t.id }}" class="text-xs text-gray-600 bg-white border border-gray-200 rounded p-3 max-h-48 overflow-y-auto whitespace-pre-wrap font-mono">{{ t.progress_log or '等待进度更新...' }}</pre>
        </td>
      </tr>
      {% endif %}
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="card text-center py-12">
  <p class="text-gray-400">暂无采集任务记录</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Toggle progress row visibility
function toggleProgress(taskId) {
  const row = document.getElementById('progress-row-' + taskId);
  if (row) row.classList.toggle('hidden');
}

// Cancel a running task
async function cancelTask(taskId) {
  if (!confirm('确定要中止此任务？相关采集数据将被删除。')) return;
  try {
    const res = await fetch(`/api/tasks/${taskId}/cancel`, { method: 'POST' });
    if (res.ok) {
      // Immediately update this row in the DOM
      const row = document.querySelector(`tr[onclick*="toggleProgress(${taskId})"]`);
      if (row) {
        // Update status badge
        const badgeCell = row.querySelector('td:nth-child(3)');
        if (badgeCell) badgeCell.innerHTML = '<span class="badge badge-orange">已中止</span>';
        // Remove cancel button
        const actionCell = row.querySelector('td:last-child');
        if (actionCell) actionCell.innerHTML = '';
        // Remove onclick (no longer running)
        row.removeAttribute('onclick');
        row.classList.remove('cursor-pointer');
      }
      // Hide progress row
      const progressRow = document.getElementById('progress-row-' + taskId);
      if (progressRow) progressRow.classList.add('hidden');
      // Stop polling this task
      runningTaskIds.delete(taskId);
    } else {
      const data = await res.json();
      alert('中止失败: ' + (data.detail || '未知错误'));
    }
  } catch (e) {
    alert('请求失败: ' + e.message);
  }
}

// Clear completed and cancelled tasks
async function clearFinished() {
  if (!confirm('确定要清空所有已完成和已中止的任务记录？')) return;
  try {
    const res = await fetch('/api/tasks/clear-finished', { method: 'DELETE' });
    if (res.ok) {
      location.reload();
    } else {
      const data = await res.json();
      alert('清空失败: ' + (data.detail || '未知错误'));
    }
  } catch (e) {
    alert('请求失败: ' + e.message);
  }
}

// Track which tasks are running for polling
const runningTaskIds = new Set();
{% for t in tasks %}
{% if t.status == 'running' %}
runningTaskIds.add({{ t.id }});
{% endif %}
{% endfor %}

// Poll progress for running tasks
async function pollProgress() {
  if (runningTaskIds.size === 0) return;

  for (const taskId of runningTaskIds) {
    try {
      const res = await fetch(`/api/tasks/${taskId}/progress`);
      if (!res.ok) continue;
      const data = await res.json();

      // Update progress log
      const logEl = document.getElementById('progress-log-' + taskId);
      if (logEl && data.progress_log) {
        logEl.textContent = data.progress_log;
        logEl.scrollTop = logEl.scrollHeight;
      }

      // Update items found
      if (data.status !== 'running') {
        runningTaskIds.delete(taskId);
        // Reload page when task completes to refresh status
        if (runningTaskIds.size === 0) {
          setTimeout(() => location.reload(), 1000);
        }
      }
    } catch (e) {
      console.error('Failed to poll progress:', e);
    }
  }
}

// Poll running status
async function checkRunning() {
  const res = await fetch('/api/tasks/running');
  const data = await res.json();
  const el = document.getElementById('runningIndicator');
  if (data.running) {
    el.innerHTML = '<span class="inline-block w-2 h-2 bg-blue-500 rounded-full animate-pulse mr-1"></span>采集中...';
    await pollProgress();
    setTimeout(checkRunning, 3000);
  } else {
    el.textContent = '';
    // If we were tracking running tasks, reload to show final state
    if (runningTaskIds.size > 0) {
      runningTaskIds.clear();
      location.reload();
    }
  }
}
checkRunning();
</script>
{% endblock %}
