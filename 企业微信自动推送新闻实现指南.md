# 企业微信自动推送新闻实现指南

## 概述

企业微信提供了多种消息推送方式，可以满足不同场景下的自动化新闻推送需求。本指南将帮助您了解实现企业微信自动推送的前置准备工作和技术方案选择。

---

## 方案选择

企业微信提供两种主要的消息推送方式，您可以根据实际需求选择：

| 方案 | 适用场景 | 复杂度 | 特点 |
|------|----------|--------|------|
| **消息推送（群机器人Webhook）** | 向特定群聊推送消息 | 低 | 无需开发应用，只需获取Webhook地址即可 |
| **自建应用消息推送** | 向指定用户/部门推送消息 | 中 | 需要创建应用，可精准控制推送对象 |

---

## 方案一：消息推送（群机器人Webhook）

这是最简单的方式，适合向企业微信群聊推送新闻消息。

### 前置准备

1. **拥有企业微信账号**：确保您已注册并加入企业微信
2. **创建或加入内部群聊**：消息推送仅支持内部群聊（不支持外部群）
3. **群管理员权限**：需要有权限在群内添加消息推送

### 配置步骤

#### 第一步：创建消息推送

**电脑端操作：**
1. 打开企业微信电脑端
2. 进入内部群聊
3. 点击右上角的「三个点」图标
4. 选择「消息推送」→「添加」
5. 新建自定义消息推送
6. 获取并保存 **Webhook URL**

**手机端操作：**
1. 打开企业微信App
2. 进入内部群聊
3. 点击右上角「三个点」进入群设置
4. 找到「消息推送」→「添加」
5. 创建自定义消息推送
6. 复制保存 **Webhook URL**

#### 第二步：保护Webhook地址

> **重要安全提示**：Webhook地址相当于推送消息的"钥匙"，务必妥善保管！
> - 不要分享到GitHub、博客等公开平台
> - 不要在前端代码中暴露
> - 建议存储在服务器端的环境变量或配置文件中

### 支持的消息类型

| 消息类型 | 说明 | 适合场景 |
|----------|------|----------|
| text | 纯文本消息 | 简单通知 |
| markdown | Markdown格式消息 | 格式化内容，支持颜色 |
| markdown_v2 | 增强版Markdown | 支持表格、代码块等 |
| news | 图文消息 | 新闻推送（推荐） |
| image | 图片消息 | 图片分享 |
| file | 文件消息 | 文档分享 |
| template_card | 模板卡片 | 丰富的交互卡片 |

### API调用示例

**Webhook地址格式：**
```
https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY
```

**推送文本消息（curl示例）：**
```bash
curl 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY' \
   -H 'Content-Type: application/json' \
   -d '{
        "msgtype": "text",
        "text": {
            "content": "今日新闻：这是一条测试消息"
        }
   }'
```

**推送图文消息（适合新闻推送）：**
```bash
curl 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY' \
   -H 'Content-Type: application/json' \
   -d '{
        "msgtype": "news",
        "news": {
           "articles": [
               {
                   "title": "今日头条新闻",
                   "description": "这是新闻的摘要内容",
                   "url": "https://example.com/news/1",
                   "picurl": "https://example.com/images/news.jpg"
               }
           ]
        }
   }'
```

**推送Markdown消息：**
```bash
curl 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY' \
   -H 'Content-Type: application/json' \
   -d '{
        "msgtype": "markdown",
        "markdown": {
            "content": "## 今日新闻速递\n> 来源：<font color=\"comment\">新闻中心</font>\n\n**头条**：这是今天的重要新闻\n\n[点击查看详情](https://example.com)"
        }
   }'
```

### Python代码示例

```python
import requests
import json

def send_wecom_message(webhook_url, news_list):
    """
    向企业微信群发送新闻消息
    
    Args:
        webhook_url: 企业微信消息推送的Webhook地址
        news_list: 新闻列表，每条新闻包含title, description, url, picurl
    """
    # 构建图文消息
    articles = []
    for news in news_list[:8]:  # 最多支持8条图文
        articles.append({
            "title": news.get("title", ""),
            "description": news.get("description", ""),
            "url": news.get("url", ""),
            "picurl": news.get("picurl", "")
        })
    
    payload = {
        "msgtype": "news",
        "news": {
            "articles": articles
        }
    }
    
    headers = {"Content-Type": "application/json"}
    response = requests.post(webhook_url, data=json.dumps(payload), headers=headers)
    
    return response.json()

# 使用示例
if __name__ == "__main__":
    WEBHOOK_URL = "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=YOUR_KEY"
    
    news = [
        {
            "title": "重要新闻标题",
            "description": "这是新闻的简要描述",
            "url": "https://example.com/news/1",
            "picurl": "https://example.com/images/1.jpg"
        }
    ]
    
    result = send_wecom_message(WEBHOOK_URL, news)
    print(result)
```

### 频率限制

- 每个消息推送：**不超过20条/分钟**

---

## 方案二：自建应用消息推送

适合需要向特定用户或部门推送消息的场景，功能更强大但配置更复杂。

### 前置准备

1. **企业微信管理员权限**：需要登录企业微信管理后台
2. **创建自建应用**：在管理后台创建专门用于消息推送的应用
3. **获取必要凭证**：corpid、agentid、secret

### 配置步骤

#### 第一步：获取企业ID（corpid）

1. 登录 [企业微信管理后台](https://work.weixin.qq.com)
2. 点击「我的企业」
3. 在「企业信息」页面底部找到「企业ID」
4. 复制保存 **corpid**

#### 第二步：创建自建应用

1. 在管理后台点击「应用管理」
2. 在「自建」区域点击「创建应用」
3. 填写应用信息：
   - 上传应用Logo
   - 填写应用名称（如"新闻推送助手"）
   - 设置可见范围（选择需要接收消息的部门或成员）
4. 点击「创建应用」

#### 第三步：获取应用凭证

创建应用后，在应用详情页获取：

| 凭证 | 获取位置 | 说明 |
|------|----------|------|
| **AgentId** | 应用详情页顶部 | 应用的唯一标识 |
| **Secret** | 应用详情页，点击「查看」 | 会发送到管理员企业微信 |

#### 第四步：配置可信IP（可选）

如果需要限制API调用来源：
1. 在应用详情页找到「企业可信IP」
2. 添加您服务器的公网IP地址

### API调用流程

```
获取access_token → 调用消息发送接口 → 处理返回结果
```

#### 获取access_token

**请求方式：** GET

**请求地址：**
```
https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=CORPID&corpsecret=SECRET
```

**返回示例：**
```json
{
   "errcode": 0,
   "errmsg": "ok",
   "access_token": "accesstoken000001",
   "expires_in": 7200
}
```

> **注意事项：**
> - access_token有效期为2小时（7200秒）
> - 需要在后端缓存access_token，避免频繁调用
> - 不要将access_token返回给前端

#### 发送应用消息

**请求方式：** POST

**请求地址：**
```
https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=ACCESS_TOKEN
```

**发送图文消息示例：**
```json
{
   "touser": "@all",
   "msgtype": "news",
   "agentid": 1000002,
   "news": {
       "articles": [
           {
               "title": "今日新闻头条",
               "description": "新闻摘要内容",
               "url": "https://example.com/news/1",
               "picurl": "https://example.com/images/1.jpg"
           }
       ]
   }
}
```

### Python完整示例

```python
import requests
import json
import time

class WeComPusher:
    """企业微信自建应用消息推送器"""
    
    def __init__(self, corpid, secret, agentid):
        self.corpid = corpid
        self.secret = secret
        self.agentid = agentid
        self.access_token = None
        self.token_expires_at = 0
    
    def get_access_token(self):
        """获取access_token，带缓存机制"""
        if self.access_token and time.time() < self.token_expires_at:
            return self.access_token
        
        url = f"https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid={self.corpid}&corpsecret={self.secret}"
        response = requests.get(url)
        data = response.json()
        
        if data.get("errcode") == 0:
            self.access_token = data["access_token"]
            self.token_expires_at = time.time() + data["expires_in"] - 300  # 提前5分钟刷新
            return self.access_token
        else:
            raise Exception(f"获取access_token失败: {data}")
    
    def send_news(self, news_list, to_user="@all", to_party=None, to_tag=None):
        """
        发送图文消息
        
        Args:
            news_list: 新闻列表
            to_user: 接收用户，@all表示所有人
            to_party: 接收部门ID
            to_tag: 接收标签ID
        """
        access_token = self.get_access_token()
        url = f"https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token={access_token}"
        
        articles = []
        for news in news_list[:8]:
            articles.append({
                "title": news.get("title", ""),
                "description": news.get("description", ""),
                "url": news.get("url", ""),
                "picurl": news.get("picurl", "")
            })
        
        payload = {
            "msgtype": "news",
            "agentid": self.agentid,
            "news": {
                "articles": articles
            }
        }
        
        if to_user:
            payload["touser"] = to_user
        if to_party:
            payload["toparty"] = to_party
        if to_tag:
            payload["totag"] = to_tag
        
        response = requests.post(url, json=payload)
        return response.json()

# 使用示例
if __name__ == "__main__":
    pusher = WeComPusher(
        corpid="YOUR_CORPID",
        secret="YOUR_SECRET",
        agentid=1000002
    )
    
    news = [
        {
            "title": "今日重要新闻",
            "description": "这是新闻的详细描述",
            "url": "https://example.com/news/1",
            "picurl": "https://example.com/images/1.jpg"
        }
    ]
    
    result = pusher.send_news(news)
    print(result)
```

### 频率限制

- 每应用每天发送量：**账号上限数 × 200 人次**
- 对同一成员：**不超过30次/分钟，1000次/小时**

---

## 方案对比与选择建议

| 对比项 | 群机器人Webhook | 自建应用 |
|--------|-----------------|----------|
| 配置复杂度 | 简单 | 中等 |
| 推送目标 | 群聊 | 用户/部门/标签 |
| 是否需要管理员权限 | 否（群管理员即可） | 是 |
| 是否需要开发应用 | 否 | 是 |
| 消息类型支持 | 8种 | 更多 |
| 频率限制 | 20条/分钟 | 更高 |
| 适用场景 | 团队内部通知 | 全员通知、精准推送 |

### 选择建议

- **选择群机器人Webhook**：如果您只需要向特定群聊推送新闻，且不需要精确控制接收人
- **选择自建应用**：如果您需要向全公司或特定部门/人员推送，或需要更高的发送频率

---

## 与新闻收集工具集成

假设您已有一个自动收集新闻的工具，可以按以下方式集成：

### 集成架构

```
新闻收集工具 → 数据处理 → 格式化消息 → 调用企业微信API → 推送到群/用户
```

### 定时推送实现

使用Python的schedule库或系统crontab实现定时推送：

```python
import schedule
import time

def job():
    # 1. 从您的新闻收集工具获取最新新闻
    news_list = your_news_collector.get_latest_news()
    
    # 2. 推送到企业微信
    send_wecom_message(WEBHOOK_URL, news_list)

# 每天早上9点推送
schedule.every().day.at("09:00").do(job)

# 每小时推送一次
# schedule.every().hour.do(job)

while True:
    schedule.run_pending()
    time.sleep(60)
```

---

## 常见问题

### Q1: Webhook地址泄露了怎么办？
A: 在群设置中删除该消息推送，重新创建一个新的即可获得新的Webhook地址。

### Q2: 图文消息的图片不显示？
A: 确保图片URL是可公开访问的HTTPS链接，且图片格式为JPG或PNG。

### Q3: access_token过期了怎么办？
A: 在代码中实现自动刷新机制，当token过期时重新获取。

### Q4: 消息发送失败返回错误码怎么处理？
A: 参考企业微信官方文档的[错误码说明](https://developer.work.weixin.qq.com/document/path/90313)进行排查。

---

## 参考资料

- [企业微信开发者中心](https://developer.work.weixin.qq.com/)
- [消息推送配置说明](https://developer.work.weixin.qq.com/document/path/99110)
- [发送应用消息](https://developer.work.weixin.qq.com/document/path/90236)
- [获取access_token](https://developer.work.weixin.qq.com/document/path/91039)
- [基本概念介绍](https://developer.work.weixin.qq.com/document/path/90665)
