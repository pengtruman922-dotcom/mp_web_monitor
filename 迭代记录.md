# 政策情报助手 — 迭代记录

---

## 迭代一：总览页和报告中心 UI 增强

### 需求描述

1. 总览页去掉"全部采集"按钮和各监控源"采集"按钮
2. 监控源状态最多展示 3 个，超过自动收起，点击可展开/收起
3. 总览摘要区域改为动态列表：支持按源筛选、按采集时间筛选（日期选择器精确到天）、按时间排序/倒序、单条删除、多选+批量删除、一键清空
4. 报告中心：支持类似的筛选、排序、删除功能

### 修改文件清单

| 文件 | 类型 | 改动说明 |
|------|------|----------|
| `app/api/results.py` | 新建 | CrawlResult 查询/删除 API |
| `app/api/reports.py` | 修改 | 增加删除/批量删除/清空端点，GET 增加日期筛选和排序参数 |
| `app/main.py` | 修改 | 注册 results 路由 |
| `app/web/routes.py` | 修改 | dashboard 移除 recent_results 查询；reports 移除服务端查询 |
| `app/web/templates/dashboard.html` | 重写 | 去按钮、源折叠、结果列表改为 JS 动态渲染+筛选/删除 |
| `app/web/templates/reports.html` | 重写 | 报告列表改为 JS 动态渲染+筛选/删除 |

### 技术细节

**新增 API — `app/api/results.py`**

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/results` | 查询结果列表，支持 `source_id`、`date_from`、`date_to`、`sort`、`limit` 参数 |
| DELETE | `/api/results/{id}` | 删除单条 |
| POST | `/api/results/batch-delete` | 批量删除，Body: `{"ids": [1,2,3]}` |
| DELETE | `/api/results/all` | 清空全部 |

GET 返回字段通过 JOIN CrawlTask 获取 `source_name`。

**修改 API — `app/api/reports.py`**

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/reports` | 新增 `date_from`、`date_to`、`sort` 参数 |
| DELETE | `/api/reports/{id}` | 新增，删除单个报告 |
| POST | `/api/reports/batch-delete` | 新增，批量删除 |
| DELETE | `/api/reports/all` | 新增，清空全部 |

**前端 — dashboard.html**

- 标题栏去掉"全部采集"按钮及其 JS
- 监控源卡片去掉"采集"按钮
- 监控源超过 3 个时自动折叠，按钮切换展开/收起
- 最新内容摘要改为 JS 动态渲染：页面加载时从 `/api/results` 获取数据，筛选控件 change 时重新请求并渲染
- 操作栏：全选、已选计数、批量删除按钮（选中时显示）、一键清空

**前端 — reports.html**

- 报告列表改为 JS 动态渲染，从 `/api/reports` 获取数据
- 筛选工具栏：日期范围 + 排序
- 操作栏：全选、批量删除、一键清空
- 每行左侧复选框，右侧删除按钮，保持原有卡片样式

---

## 迭代二：报告重复概述 + 摘要与标题重复

### 问题描述

1. 采集报告详情页重复显示了两个"整体概述"
2. 采集到的信息摘要（summary）与标题（title）完全相同，不是对原文内容的精简总结

### 问题根因

**问题 1**：`content_html` 在生成时已经包含了一个带样式的"整体概述"区块（orchestrator.py），而 `report_detail.html` 模板又单独渲染了一遍 `report.overview`，导致重复。

**问题 2**：`runtime.py` 中 `save_results_batch` 的 summary 字段 fallback 为 `item.get("title", "")`，当 LLM 未提供 summary 时直接用标题填充。

### 修改文件清单

| 文件 | 改动说明 |
|------|----------|
| `app/web/templates/report_detail.html` | 删除单独渲染 overview 的区块，只保留 content_html 中自带的概述 |
| `app/agent/runtime.py` | summary fallback 从 `item.get("title","")` 改为 `""` |
| `app/agent/prompts.py` | 更新提示词，要求 agent 为每条内容编写不同于标题的摘要 |

---

## 迭代三：采集按钮状态 + 并发采集 + 删除功能报错

### 问题描述

1. 监控源页面点击"采集"后，按钮应变为"采集中"并不可二次点击
2. A 监控源采集中时，点击 B 监控源采集提示不可采集，应改为可独立采集
3. 总览和报告 tab 的删除、一键清空功能点击后报错

### 问题根因

**问题 1**：按钮点击后没有任何 UI 状态变化，无 disabled 也无文字更新。

**问题 2**：`orchestrator.py` 使用全局布尔锁 `_running = True/False`，任一源采集中时阻止所有新任务。`tasks.py` 的 `trigger_crawl` 在 `is_running()` 为 True 时直接返回 409。

**问题 3**：FastAPI 路由顺序问题。`DELETE /api/results/all` 定义在 `DELETE /api/results/{result_id}` 之后，FastAPI 先匹配 `/{result_id}`，尝试将 `"all"` 解析为 `int` 导致 422 验证错误。`reports.py` 同理。

### 修改文件清单

| 文件 | 改动说明 |
|------|----------|
| `app/agent/orchestrator.py` | 全局 `_running` 布尔锁改为 `_running_sources: set[int]` 按源粒度锁；新增 `get_running_sources()` |
| `app/api/tasks.py` | `trigger_crawl` 改为按源检查，仅当所有请求的源都在运行时才返回 409；`/running` 端点增加返回 `running_source_ids` |
| `app/web/templates/sources.html` | 采集按钮加 id，点击后变为"采集中..."并 disabled；页面加载时检查运行状态；每 3 秒轮询自动恢复按钮 |
| `app/api/results.py` | `/batch-delete` 和 `/all` 路由移到 `/{id}` 之前 |
| `app/api/reports.py` | `/batch-delete` 和 `/all` 路由移到 `/{report_id}` 之前 |

### 技术细节

**按源粒度锁 — orchestrator.py**

```python
# 之前（全局锁）
_running = False

# 之后（按源锁）
_running_sources: set[int] = set()
```

`run_batch` 不再整体加锁，而是过滤掉已在运行的源，只运行空闲的源。每个源完成后在 `finally` 中单独释放锁。

**按钮状态 — sources.html**

- 按钮 id 格式 `triggerBtn-{source_id}`
- 点击后立即 `disabled + textContent='采集中...'`
- 页面加载调用 `GET /api/tasks/running` 设置初始状态
- `setInterval` 3 秒轮询运行状态，完成后自动恢复按钮

**路由顺序 — results.py / reports.py**

静态路径 `/batch-delete`、`/all` 必须定义在动态路径 `/{id}` 之前，否则 FastAPI 会将 `"all"` 尝试匹配为 int 参数导致 422。

---

## 迭代四：摘要内容质量优化 + 模型更换

### 问题描述

1. 采集结果的摘要（summary）仍然与标题相同，LLM 未能生成有意义的内容概括
2. 用户要求更换 LLM 模型为 gpt-5

### 问题根因

这不是模型能力问题，而是**采集流程设计问题**。当前工作流分两种保存路径：

- **列表页批量保存**（`save_results_batch`）：浏览器工具从列表页提取标题+链接+日期，agent 直接批量保存。由于没有访问详情页，agent 没有正文内容可供总结，只能把标题复制到 summary。
- **详情页单条保存**（`save_result`）：agent 进入详情页读取正文后保存，此时可以生成有意义的摘要。

实际采集中绝大多数条目走批量路径，因此摘要基本等于标题。

### 修改文件清单

| 文件 | 改动说明 |
|------|----------|
| `app/agent/runtime.py` | `save_result` 和 `save_results_batch` 两个保存路径增加检查：`summary == title` 时强制置空 |
| `app/agent/orchestrator.py` | 新增 `_enrich_summaries()` 后处理函数；报告生成时跳过与标题相同的摘要 |
| `app/agent/prompts.py` | 重写工作流说明：批量保存不需要填 summary，只有进详情页才填 |
| `app/web/templates/dashboard.html` | JS 渲染时跳过与标题相同的 summary |
| 数据库 `llm_configs` 表 | 更新 LLM 配置为 gpt-5 |

### 技术细节

**摘要后处理 — `_enrich_summaries()`**

在 agent 采集完成、去重裁剪之后，保存到数据库之前，自动执行摘要补全：

1. 筛选出所有 `summary` 为空的条目
2. 逐条用 `browse_page` 访问详情页，提取正文（截取前 6000 字符）
3. 调用 LLM 生成 2-3 句话（100-200 字）的内容概括
4. 验证摘要不为空且不等于标题后写入
5. 进度实时写入任务日志
6. 单条失败不影响其他条目

```
采集流程（改进后）：
列表页扫描 → 批量保存（无摘要）→ 去重裁剪 → 逐条访问详情页生成摘要 → 写入数据库 → 生成报告
```

**多层去重保护 — summary ≠ title**

| 层级 | 位置 | 处理方式 |
|------|------|----------|
| 数据入口 | `runtime.py` save_result / save_results_batch | `summary.strip() == title.strip()` 时置空 |
| 报告生成 | `orchestrator.py` _generate_report | 只在 summary 存在且不等于 title 时才输出 |
| 前端展示 | `dashboard.html` renderResults | JS 判断 `summary.trim() !== title.trim()` 才渲染 |

**LLM 模型配置更新**

| 配置项 | 旧值 | 新值 |
|--------|------|------|
| API 地址 | （原配置） | `https://poloai.top/v1` |
| 模型名称 | （原配置） | `gpt-5` |
| 配置名称 | （原配置） | `GPT-5` |
